name: NextShift CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Prevent concurrent runs on same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-pwa:
    name: Validate PWA
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Validate JavaScript
        run: |
          echo "Validating TypeScript and React files..."
          npx tsc --noEmit
          echo "‚úÖ JavaScript syntax is valid"

      - name: Run code quality checks
        run: |
          echo "Running Biome linting and tests..."
          npm run lint
          npm run test
          echo "‚úÖ All quality checks passed"

      - name: Build and check PWA
        run: |
          echo "Building PWA with Vite..."
          npm run build

          echo "Checking built PWA requirements..."
          # Core source files (Vite structure)
          [ -f "index.html" ] && echo "‚úÖ index.html found" || { echo "‚ùå index.html missing"; exit 1; }
          [ -f "src/styles/main.scss" ] && echo "‚úÖ src/styles/main.scss found" || { echo "‚ùå src/styles/main.scss missing"; exit 1; }
          [ -f "src/App.tsx" ] && echo "‚úÖ src/App.tsx found" || { echo "‚ùå src/App.tsx missing"; exit 1; }

          # Built PWA files (auto-generated by Vite)
          [ -f "dist/index.html" ] && echo "‚úÖ Built index.html found" || { echo "‚ùå Built index.html missing"; exit 1; }
          [ -f "dist/manifest.webmanifest" ] && echo "‚úÖ Auto-generated manifest found" || { echo "‚ùå Manifest missing"; exit 1; }

          # Check for built CSS (Vite generates hashed filenames in subdirectories)
          if ls dist/assets/css/*.css 1> /dev/null 2>&1; then
            echo "‚úÖ Built CSS files found"
          else
            echo "‚ùå Built CSS files missing"
            exit 1
          fi

          # Check for built JS (Vite generates hashed filenames in subdirectories)
          if ls dist/assets/js/*.js 1> /dev/null 2>&1; then
            echo "‚úÖ Built JS files found"
          else
            echo "‚ùå Built JS files missing"
            exit 1
          fi

          # PWA assets (moved to public/assets structure)
          [ -f "public/assets/icons/icon-192.png" ] && echo "‚úÖ 192px icon found" || { echo "‚ùå 192px icon missing"; exit 1; }
          [ -f "public/assets/icons/icon-512.png" ] && echo "‚úÖ 512px icon found" || { echo "‚ùå 512px icon missing"; exit 1; }

          echo "‚úÖ All PWA requirements met"

      - name: Calculate bundle size
        run: |
          echo "Calculating built PWA bundle size..."

          # Calculate built bundle size
          DIST_SIZE=$(du -sb dist/ | cut -f1)
          ICONS_SIZE=$(du -sb public/assets/icons/ | cut -f1)
          TOTAL_SIZE=$((DIST_SIZE + ICONS_SIZE))
          TOTAL_KB=$(( (TOTAL_SIZE + 1023) / 1024 ))

          echo "üìä Bundle Size Analysis:"
          echo "‚îú‚îÄ‚îÄ Built assets: $(( (DIST_SIZE + 1023) / 1024 ))KB"
          echo "‚îú‚îÄ‚îÄ Icons: $(( (ICONS_SIZE + 1023) / 1024 ))KB"
          echo "‚îî‚îÄ‚îÄ Total: ${TOTAL_KB}KB"

          # List built files for transparency
          echo ""
          echo "üìÅ Built files:"
          find dist -type f -exec ls -lh {} \; | awk '{print "‚îú‚îÄ‚îÄ " $9 ": " $5}'

          # Bundle size check (warn if over 500KB)
          if [ $TOTAL_KB -gt 500 ]; then
            echo "‚ö†Ô∏è  Bundle size is large (${TOTAL_KB}KB > 500KB)"
          else
            echo "‚úÖ Bundle size is optimal (${TOTAL_KB}KB)"
          fi

          # Save for PR comment
          echo "BUNDLE_SIZE=${TOTAL_KB}KB" >> $GITHUB_ENV

      - name: Validate PWA manifest
        run: |
          echo "Validating auto-generated PWA manifest..."

          # Check built manifest
          node -e "
            const manifest = JSON.parse(require('fs').readFileSync('dist/manifest.webmanifest', 'utf8'));
            const required = ['name', 'short_name', 'icons', 'start_url', 'display'];

            required.forEach(field => {
              if (!manifest[field]) {
                console.log(\`‚ùå Missing required field: \${field}\`);
                process.exit(1);
              } else {
                console.log(\`‚úÖ \${field}: \${JSON.stringify(manifest[field]).substring(0, 50)}...\`);
              }
            });

            // Check icons
            if (!manifest.icons || manifest.icons.length === 0) {
              console.log('‚ùå No icons defined in manifest');
              process.exit(1);
            }

            console.log('‚úÖ Auto-generated PWA manifest is valid');
          "

      - name: Check shift calculation accuracy
        run: |
          echo "Testing shift calculation logic..."

          # Basic test - check if core utility files exist
          echo "Checking React app structure..."
          [ -f "src/utils/shiftCalculations.ts" ] && echo "‚úÖ Shift calculations utility found" || { echo "‚ùå Shift calculations missing"; exit 1; }
          [ -f "src/hooks/useShiftCalculation.ts" ] && echo "‚úÖ Shift calculation hook found" || { echo "‚ùå Shift calculation hook missing"; exit 1; }
          [ -f "src/components/WelcomeWizard.tsx" ] && echo "‚úÖ WelcomeWizard component found" || { echo "‚ùå WelcomeWizard component missing"; exit 1; }
          echo "‚úÖ React app structure validated"

      - name: Build comment body
        if: github.event_name == 'pull_request'
        id: build-comment
        run: |
          {
            echo 'COMMENT_BODY<<EOF'
            echo "## üöÄ PWA Validation Results"
            echo ""
            echo "‚úÖ All PWA requirements met"
            echo "‚úÖ Code quality checks passed (Biome)"
            echo "‚úÖ Tests passed (Vitest)"
            echo "‚úÖ Build successful (Vite)"
            echo "‚úÖ Auto-generated manifest valid"
            echo "‚úÖ Required icons present"
            echo "‚úÖ Core shift functions present"
            echo ""
            echo "üìä **Bundle Size:** ${BUNDLE_SIZE}"
            echo ""
            echo "Ready for deployment! üéâ"
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: ./.github/actions/upsert-comment
        with:
          comment-identifier: 'üöÄ PWA Validation Results'
          comment-body: ${{ env.COMMENT_BODY }}
