name: NextShift CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Prevent concurrent runs on same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-pwa:
    name: Validate PWA
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install validation tools
        run: |
          npm install -g eslint stylelint lighthouse-ci @lhci/cli

      - name: Validate JavaScript
        run: |
          echo "Validating JavaScript syntax..."
          node -c app.js
          echo "âœ… JavaScript syntax is valid"

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          node -e "JSON.parse(require('fs').readFileSync('manifest.json', 'utf8'))" && echo "âœ… manifest.json is valid"
          node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" 2>/dev/null && echo "âœ… package.json is valid" || echo "â„¹ï¸  No package.json found"

      - name: Check PWA requirements
        run: |
          echo "Checking PWA file requirements..."

          # Core files
          [ -f "index.html" ] && echo "âœ… index.html found" || { echo "âŒ index.html missing"; exit 1; }
          [ -f "manifest.json" ] && echo "âœ… manifest.json found" || { echo "âŒ manifest.json missing"; exit 1; }
          [ -f "serviceWorker.js" ] && echo "âœ… serviceWorker.js found" || { echo "âŒ serviceWorker.js missing"; exit 1; }

          # PWA assets
          [ -f "assets/icons/icon-192.png" ] && echo "âœ… 192px icon found" || { echo "âŒ 192px icon missing"; exit 1; }
          [ -f "assets/icons/icon-512.png" ] && echo "âœ… 512px icon found" || { echo "âŒ 512px icon missing"; exit 1; }

          # Check service worker registration
          grep -q "serviceWorker.register" index.html && echo "âœ… Service worker registration found" || { echo "âŒ Service worker registration missing"; exit 1; }

          echo "âœ… All PWA requirements met"

      - name: Calculate bundle size
        run: |
          echo "Calculating PWA bundle size..."

          # Calculate sizes
          HTML_SIZE=$(stat -c%s index.html)
          CSS_SIZE=$(stat -c%s style.css)
          JS_SIZE=$(stat -c%s app.js)
          SW_SIZE=$(stat -c%s serviceWorker.js)
          MANIFEST_SIZE=$(stat -c%s manifest.json)
          ICONS_SIZE=$(du -sb assets/icons/ | cut -f1)

          TOTAL_SIZE=$((HTML_SIZE + CSS_SIZE + JS_SIZE + SW_SIZE + MANIFEST_SIZE + ICONS_SIZE))
          TOTAL_KB=$((TOTAL_SIZE / 1024))

          echo "ğŸ“Š Bundle Size Analysis:"
          echo "â”œâ”€â”€ HTML: $((HTML_SIZE / 1024))KB"
          echo "â”œâ”€â”€ CSS: $((CSS_SIZE / 1024))KB"
          echo "â”œâ”€â”€ JavaScript: $((JS_SIZE / 1024))KB"
          echo "â”œâ”€â”€ Service Worker: $((SW_SIZE / 1024))KB"
          echo "â”œâ”€â”€ Manifest: $((MANIFEST_SIZE / 1024))KB"
          echo "â”œâ”€â”€ Icons: $((ICONS_SIZE / 1024))KB"
          echo "â””â”€â”€ Total: ${TOTAL_KB}KB"

          # Bundle size check (warn if over 500KB)
          if [ $TOTAL_KB -gt 500 ]; then
            echo "âš ï¸  Bundle size is large (${TOTAL_KB}KB > 500KB)"
          else
            echo "âœ… Bundle size is optimal (${TOTAL_KB}KB)"
          fi

          # Save for PR comment
          echo "BUNDLE_SIZE=${TOTAL_KB}KB" >> $GITHUB_ENV

      - name: Validate PWA manifest
        run: |
          echo "Validating PWA manifest structure..."

          # Check required manifest fields
          node -e "
            const manifest = JSON.parse(require('fs').readFileSync('manifest.json', 'utf8'));
            const required = ['name', 'short_name', 'icons', 'start_url', 'display'];

            required.forEach(field => {
              if (!manifest[field]) {
                console.log(\`âŒ Missing required field: \${field}\`);
                process.exit(1);
              } else {
                console.log(\`âœ… \${field}: \${JSON.stringify(manifest[field]).substring(0, 50)}...\`);
              }
            });

            // Check icons
            if (!manifest.icons || manifest.icons.length === 0) {
              console.log('âŒ No icons defined in manifest');
              process.exit(1);
            }

            console.log('âœ… PWA manifest is valid');
          "

      - name: Check shift calculation accuracy
        run: |
          echo "Testing shift calculation logic..."

          # Basic test - check if core functions exist
          node -e "
            const fs = require('fs');
            const appJs = fs.readFileSync('app.js', 'utf8');

            const requiredFunctions = [
              'calculateShift',
              'formatDateCode',
              'getNextShift',
              'getCurrentShiftDay'
            ];

            requiredFunctions.forEach(func => {
              if (appJs.includes('function ' + func) || appJs.includes(func + ' =')) {
                console.log(\`âœ… \${func} function found\`);
              } else {
                console.log(\`âŒ \${func} function missing\`);
                process.exit(1);
              }
            });

            console.log('âœ… Core shift functions are present');
          "

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const bundleSize = process.env.BUNDLE_SIZE;

            const comment = `## ğŸš€ PWA Validation Results

            âœ… All PWA requirements met
            âœ… JavaScript syntax valid
            âœ… Manifest structure valid
            âœ… Service worker configured
            âœ… Required icons present
            âœ… Core shift functions present

            ğŸ“Š **Bundle Size:** ${bundleSize}

            Ready for deployment! ğŸ‰`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
