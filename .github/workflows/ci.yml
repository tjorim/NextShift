name: NextShift CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Prevent concurrent runs on same ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-pwa:
    name: Validate PWA
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Validate JavaScript
        run: |
          echo "Validating TypeScript and React files..."
          npx tsc --noEmit
          echo "âœ… JavaScript syntax is valid"

      - name: Run code quality checks
        run: |
          echo "Running Biome linting and tests..."
          npm run lint
          npm run test
          echo "âœ… All quality checks passed"

      - name: Build and check PWA
        run: |
          echo "Building PWA with Vite..."
          npm run build

          echo "Checking built PWA requirements..."
          # Core source files (Vite structure)
          [ -f "index.html" ] && echo "âœ… index.html found" || { echo "âŒ index.html missing"; exit 1; }
          [ -f "src/styles/main.css" ] && echo "âœ… src/styles/main.css found" || { echo "âŒ src/styles/main.css missing"; exit 1; }
          [ -f "src/App.tsx" ] && echo "âœ… src/App.tsx found" || { echo "âŒ src/App.tsx missing"; exit 1; }

          # Built PWA files (auto-generated by Vite)
          [ -f "dist/index.html" ] && echo "âœ… Built index.html found" || { echo "âŒ Built index.html missing"; exit 1; }
          [ -f "dist/manifest.webmanifest" ] && echo "âœ… Auto-generated manifest found" || { echo "âŒ Manifest missing"; exit 1; }
          
          # Check for built CSS (Vite generates hashed filenames)
          if ls dist/assets/*.css 1> /dev/null 2>&1; then
            echo "âœ… Built CSS files found"
          else
            echo "âŒ Built CSS files missing"
            exit 1
          fi
          
          # Check for built JS (Vite generates hashed filenames)  
          if ls dist/assets/*.js 1> /dev/null 2>&1; then
            echo "âœ… Built JS files found"
          else
            echo "âŒ Built JS files missing"
            exit 1
          fi

          # PWA assets (moved to public/assets structure)
          [ -f "public/assets/icons/icon-192.png" ] && echo "âœ… 192px icon found" || { echo "âŒ 192px icon missing"; exit 1; }
          [ -f "public/assets/icons/icon-512.png" ] && echo "âœ… 512px icon found" || { echo "âŒ 512px icon missing"; exit 1; }

          echo "âœ… All PWA requirements met"

      - name: Calculate bundle size
        run: |
          echo "Calculating built PWA bundle size..."

          # Calculate built bundle size
          DIST_SIZE=$(du -sb dist/ | cut -f1)
          ICONS_SIZE=$(du -sb public/assets/icons/ | cut -f1)
          TOTAL_SIZE=$((DIST_SIZE + ICONS_SIZE))
          TOTAL_KB=$(( (TOTAL_SIZE + 1023) / 1024 ))

          echo "ğŸ“Š Bundle Size Analysis:"
          echo "â”œâ”€â”€ Built assets: $(( (DIST_SIZE + 1023) / 1024 ))KB"
          echo "â”œâ”€â”€ Icons: $(( (ICONS_SIZE + 1023) / 1024 ))KB"
          echo "â””â”€â”€ Total: ${TOTAL_KB}KB"

          # List built files for transparency
          echo ""
          echo "ğŸ“ Built files:"
          find dist -type f -exec ls -lh {} \; | awk '{print "â”œâ”€â”€ " $9 ": " $5}'

          # Bundle size check (warn if over 500KB)
          if [ $TOTAL_KB -gt 500 ]; then
            echo "âš ï¸  Bundle size is large (${TOTAL_KB}KB > 500KB)"
          else
            echo "âœ… Bundle size is optimal (${TOTAL_KB}KB)"
          fi

          # Save for PR comment
          echo "BUNDLE_SIZE=${TOTAL_KB}KB" >> $GITHUB_ENV

      - name: Validate PWA manifest
        run: |
          echo "Validating auto-generated PWA manifest..."

          # Check built manifest
          node -e "
            const manifest = JSON.parse(require('fs').readFileSync('dist/manifest.webmanifest', 'utf8'));
            const required = ['name', 'short_name', 'icons', 'start_url', 'display'];

            required.forEach(field => {
              if (!manifest[field]) {
                console.log(\`âŒ Missing required field: \${field}\`);
                process.exit(1);
              } else {
                console.log(\`âœ… \${field}: \${JSON.stringify(manifest[field]).substring(0, 50)}...\`);
              }
            });

            // Check icons
            if (!manifest.icons || manifest.icons.length === 0) {
              console.log('âŒ No icons defined in manifest');
              process.exit(1);
            }

            console.log('âœ… Auto-generated PWA manifest is valid');
          "

      - name: Check shift calculation accuracy
        run: |
          echo "Testing shift calculation logic..."

          # Basic test - check if core utility files exist
          echo "Checking React app structure..."
          [ -f "src/utils/shiftCalculations.ts" ] && echo "âœ… Shift calculations utility found" || { echo "âŒ Shift calculations missing"; exit 1; }
          [ -f "src/hooks/useShiftCalculation.ts" ] && echo "âœ… Shift calculation hook found" || { echo "âŒ Shift calculation hook missing"; exit 1; }
          [ -f "src/components/TeamSelector.tsx" ] && echo "âœ… TeamSelector component found" || { echo "âŒ TeamSelector component missing"; exit 1; }
          echo "âœ… React app structure validated"

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const bundleSize = process.env.BUNDLE_SIZE;

            const comment = `## ğŸš€ PWA Validation Results

            âœ… All PWA requirements met
            âœ… Code quality checks passed (Biome)
            âœ… Tests passed (Vitest)
            âœ… Build successful (Vite)
            âœ… Auto-generated manifest valid
            âœ… Required icons present
            âœ… Core shift functions present

            ğŸ“Š **Bundle Size:** ${bundleSize}

            Ready for deployment! ğŸ‰`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
