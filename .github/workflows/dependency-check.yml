name: Dependency Monitor

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  check-dependencies:
    name: Check CDN Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Check CDN versions
        run: |
          echo "ğŸ” Checking CDN dependency versions..."
          
          # Extract current versions from index.html
          echo "Current versions in index.html:"
          
          # Day.js version
          DAYJS_CURRENT=$(grep -o 'dayjs@[0-9.]*' index.html | head -1 | cut -d'@' -f2)
          echo "â”œâ”€â”€ Day.js: ${DAYJS_CURRENT}"
          
          # Bootstrap version  
          BOOTSTRAP_CURRENT=$(grep -o 'bootstrap@[0-9.]*' index.html | head -1 | cut -d'@' -f2)
          echo "â”œâ”€â”€ Bootstrap: ${BOOTSTRAP_CURRENT}"
          
          # Check latest versions from npm
          echo ""
          echo "ğŸ” Checking latest versions..."
          
          # Day.js latest
          DAYJS_LATEST=$(npm view dayjs version)
          echo "â”œâ”€â”€ Day.js latest: ${DAYJS_LATEST}"
          
          # Bootstrap latest
          BOOTSTRAP_LATEST=$(npm view bootstrap version)
          echo "â”œâ”€â”€ Bootstrap latest: ${BOOTSTRAP_LATEST}"
          
          # Version comparison
          echo ""
          echo "ğŸ“Š Version Status:"
          
          if [ "$DAYJS_CURRENT" = "$DAYJS_LATEST" ]; then
            echo "âœ… Day.js is up to date"
          else
            echo "âš ï¸  Day.js update available: ${DAYJS_CURRENT} â†’ ${DAYJS_LATEST}"
            echo "DAYJS_UPDATE_AVAILABLE=true" >> $GITHUB_ENV
            echo "DAYJS_NEW_VERSION=${DAYJS_LATEST}" >> $GITHUB_ENV
          fi
          
          if [ "$BOOTSTRAP_CURRENT" = "$BOOTSTRAP_LATEST" ]; then
            echo "âœ… Bootstrap is up to date"
          else
            echo "âš ï¸  Bootstrap update available: ${BOOTSTRAP_CURRENT} â†’ ${BOOTSTRAP_LATEST}"
            echo "BOOTSTRAP_UPDATE_AVAILABLE=true" >> $GITHUB_ENV  
            echo "BOOTSTRAP_NEW_VERSION=${BOOTSTRAP_LATEST}" >> $GITHUB_ENV
          fi
          
      - name: Security audit
        run: |
          echo "ğŸ”’ Running security checks..."
          
          # Check for known vulnerabilities in CDN versions
          # This is a basic check - for production you might want more sophisticated tools
          
          echo "Checking CDN security advisories..."
          
          # Check if any version strings look suspicious (basic validation)
          if grep -q 'http://' index.html; then
            echo "âš ï¸  Found HTTP CDN links - should use HTTPS"
          else
            echo "âœ… All CDN links use HTTPS"
          fi
          
          # Check for integrity hashes (SRI)
          if grep -q 'integrity=' index.html; then
            echo "âœ… CDN integrity hashes found"
          else
            echo "â„¹ï¸  Consider adding SRI integrity hashes to CDN links"
          fi
          
      - name: Create issue for updates
        if: env.DAYJS_UPDATE_AVAILABLE == 'true' || env.BOOTSTRAP_UPDATE_AVAILABLE == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { DAYJS_UPDATE_AVAILABLE, DAYJS_NEW_VERSION, BOOTSTRAP_UPDATE_AVAILABLE, BOOTSTRAP_NEW_VERSION } = process.env;
            
            let updates = [];
            if (DAYJS_UPDATE_AVAILABLE === 'true') {
              updates.push(`- **Day.js**: Update to ${DAYJS_NEW_VERSION}`);
            }
            if (BOOTSTRAP_UPDATE_AVAILABLE === 'true') {
              updates.push(`- **Bootstrap**: Update to ${BOOTSTRAP_NEW_VERSION}`);
            }
            
            if (updates.length === 0) return;
            
            const body = `## ğŸ“¦ Dependency Updates Available
            
            The following CDN dependencies have updates available:
            
            ${updates.join('\n')}
            
            ### Recommended Actions:
            1. Review changelog for breaking changes
            2. Test updates in development
            3. Update CDN links in \`index.html\`
            4. Test PWA functionality after updates
            
            ### Current CDN Links:
            - Day.js: \`https://cdn.jsdelivr.net/npm/dayjs@...\`
            - Bootstrap: \`https://cdn.jsdelivr.net/npm/bootstrap@...\`
            
            > ğŸ¤– This issue was automatically created by the dependency monitor workflow.`;
            
            // Check if similar issue already exists
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'dependencies',
              state: 'open'
            });
            
            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ“¦ CDN Dependency Updates Available',
                body: body,
                labels: ['dependencies', 'enhancement']
              });
              
              console.log('âœ… Created dependency update issue');
            } else {
              console.log('â„¹ï¸  Dependency update issue already exists');
            }
            
      - name: Summary
        run: |
          echo "ğŸ¯ Dependency Check Summary:"
          echo "â”œâ”€â”€ âœ… CDN versions checked"
          echo "â”œâ”€â”€ âœ… Security audit completed"
          echo "â”œâ”€â”€ âœ… HTTPS verification done"
          
          if [ "${{ env.DAYJS_UPDATE_AVAILABLE }}" = "true" ] || [ "${{ env.BOOTSTRAP_UPDATE_AVAILABLE }}" = "true" ]; then
            echo "â”œâ”€â”€ ğŸ“¦ Updates available - issue created"
          else
            echo "â”œâ”€â”€ âœ… All dependencies up to date"
          fi
          
          echo "â””â”€â”€ ğŸ”„ Next check scheduled for next Monday"